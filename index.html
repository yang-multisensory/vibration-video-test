<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vibration‑Enhanced Video Playback</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background: #f9f9f9;
    }
    video {
      width: 90%;
      max-width: 720px;
      margin-top: 20px;
    }
    progress {
      width: 80%;
      height: 20px;
      margin: 10px auto;
    }
    #bootText { color: #555; font-size: 16px; }
    button {
      padding: 12px 24px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <video id="myVideo" preload="metadata" playsinline style="display:none;">
    <source src="https://yang-multisensory.github.io/vibration-video-test/Chocolate%20Factory%20240.mp4" type="video/mp4" />
    Your browser does not support this video format.
  </video>

  <br />
  <progress id="bootProgress" value="0" max="5"></progress>
  <p id="bootText">⌛ Loading… Please wait <span id="bootCountdown">5</span> seconds</p>
  <br />
  <button id="playBtn" style="display:none;">▶ Play</button>
  <button id="backBtn" style="display:none; margin-left:12px;">⇦ 返回问卷</button>

  <script>
  const params     = new URLSearchParams(location.search);
  const vpid       = params.get('vpid');
  const sidParam   = params.get('sid');

  const surveyId   = sidParam || 'SV_0wiqiprV28o9d4y';
  const qualDomain = 'oxfordxpsy.pdx1.qualtrics.com';
  const qualReturn = `https://${qualDomain}/jfe/form/${surveyId}` +
                     `?Q_R=${encodeURIComponent(vpid)}&Q_TICKET=STI-HP`;

  const video         = document.getElementById('myVideo');
  const progressBar   = document.getElementById('bootProgress');
  const bootText      = document.getElementById('bootText');
  const bootCountdown = document.getElementById('bootCountdown');
  const playBtn       = document.getElementById('playBtn');
  const backBtn       = document.getElementById('backBtn');

  let vibrationStarted  = false;
  let vibrationInterval = null;
  let vibrationStep     = 0;
  let vibrationActive   = false;

  video.load();
  video.currentTime = 0.1;

  let count = 5;
  const bootTimer = setInterval(() => {
    bootCountdown.textContent = --count;
    progressBar.value = 5 - count;
    if (count <= 0) {
      clearInterval(bootTimer);
      bootText.style.display   = 'none';
      progressBar.style.display = 'none';
      video.style.display      = 'block';
      playBtn.style.display    = 'inline-block';
      backBtn.style.display    = 'inline-block';
    }
  }, 1_000);

  backBtn.onclick = () => (window.location.href = qualReturn);

  playBtn.addEventListener('click', () => {
    if (video.paused) {
      video.play();
      playBtn.textContent = '⏸ Pause';
      if (vibrationActive) resumeVibration();
    } else {
      video.pause();
      playBtn.textContent = '▶ Play';
      stopVibration();
    }
  });

  function resumeVibration() {
    if (!navigator.vibrate) return;
    const baseInterval = (vibrationStep < 5) ? 2_000 : 500;
    vibrationInterval = setInterval(() => {
      navigator.vibrate(200);
      if (++vibrationStep === 5 && baseInterval !== 500) {
        clearInterval(vibrationInterval);
        vibrationInterval = setInterval(() => navigator.vibrate(200), 500);
      }
    }, baseInterval);
  }
  function startVibration() {
    vibrationStarted = true;
    vibrationActive  = true;
    vibrationStep    = 0;
    resumeVibration();
  }
  function stopVibration() {
    if (vibrationInterval) clearInterval(vibrationInterval);
    navigator.vibrate(0);
    vibrationActive = false;
  }

  video.addEventListener('timeupdate', () => {
    if (!vibrationStarted && video.currentTime >= 37.5) startVibration();
  });

  video.addEventListener('ended', () => {
    stopVibration();
    vibrationStarted = false;
    vibrationStep    = 0;
    playBtn.textContent = '▶ Play';
  });

  video.addEventListener('pause', stopVibration);
  </script>
</body>
</html>
